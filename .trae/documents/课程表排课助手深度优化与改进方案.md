## 项目现状概览
- 后端：FastAPI 提供课程与学生的 CRUD，以及 AI 流式接口 [main.py](file:///i:/课程表排课助手/backend/main.py)
- 数据层：使用 PyMySQL 直连远程 MySQL，集中在服务层 [service.py](file:///i:/课程表排课助手/backend/service.py#L13-L21)
- AI 编排：LangGraph + SiliconFlow GLM-4.6，绑定大量工具函数 [ai_graph.py](file:///i:/课程表排课助手/backend/ai_graph.py#L48-L99)、[tools.py](file:///i:/课程表排课助手/backend/tools.py)
- 前端：原生 HTML/JS/CSS，FullCalendar 渲染课程；AI 面板支持流式展示与重试 [index.html](file:///i:/课程表排课助手/frontend/index.html)、[script.js](file:///i:/课程表排课助手/frontend/script.js)、[style.css](file:///i:/课程表排课助手/frontend/style.css)

## 关键问题与风险
- 敏感信息硬编码
  - 数据库凭据写死在 [service.py](file:///i:/课程表排课助手/backend/service.py#L13-L21)
  - SiliconFlow API Key 写死在 [ai_graph.py](file:///i:/课程表排课助手/backend/ai_graph.py#L48-L52)
- CORS 全开放：后端允许所有来源 [main.py](file:///i:/课程表排课助手/backend/main.py#L12-L18)
- 会话上下文固定：AI 使用固定 thread_id [ai_service.py](file:///i:/课程表排课助手/backend/ai_service.py#L12-L16)
- 连接管理：每次调用创建/关闭连接，无连接池与健康检查 [service.py](file:///i:/课程表排课助手/backend/service.py#L24-L40)
- 模型不一致：Course.id 为 UUID 字符串、Student.id 为整型；需确认数据库主键/索引设计与一致性 [models.py](file:///i:/课程表排课助手/backend/models.py#L59-L65)
- 流式返回类型与前端处理：后端声明 application/json 流，前端同时接受 text/plain；推荐标准化为 NDJSON 或 SSE
- 部署与可观测性：缺少日志规范、健康检查、Docker 化与 CI

## 优化目标
- 安全合规：移除硬编码密钥/凭据，细化 CORS，引入速率限制
- 性能稳定：连接池、索引优化、分页与筛选、服务端冲突检测
- 开发效率：ORM 与迁移、统一错误响应、测试与 CI
- 体验提升：AI 流稳定与可控、前端交互与时区/i18n、批量/周期 UI

## 优化与改进方案（分阶段）
### 阶段 1｜安全与配置
1. 引入环境变量配置（.env / 系统环境），移除硬编码：DB、LLM Key、CORS 来源
2. 封装配置加载（如 Pydantic BaseSettings）并在 [main.py](file:///i:/课程表排课助手/backend/main.py) 与 [ai_graph.py](file:///i:/课程表排课助手/backend/ai_graph.py) 使用
3. CORS 仅允许前端域名，区分开发/生产；增加请求体大小限制与速率限制（中间件）

### 阶段 2｜数据层与业务稳健性
1. 迁移到 ORM + 迁移工具：SQLAlchemy + Alembic（新增依赖）
2. 设计/固化 schema（students、courses）：主键类型统一；为 start、student_id、title 建索引
3. 引入连接池（SQLAlchemy Engine Pool），设置合理 pool_pre_ping、超时与重试策略
4. 冲突检测下沉到数据库查询，避免全量拉取后在内存判定（参照 [tools.py](file:///i:/课程表排课助手/backend/tools.py#L125-L139) 与 [service.py](file:///i:/课程表排课助手/backend/service.py)）

### 阶段 3｜API 设计与错误处理
1. 统一错误响应模型（ErrorResponse），所有路由使用一致的状态码与 detail 字段 [main.py](file:///i:/课程表排课助手/backend/main.py#L30-L42)
2. 课程与学生列表支持分页/过滤/排序（REST 查询参数），减少前端与 AI 的大列表消耗
3. 数据校验与边界：价格最小值、时间合法性（end > start）、location 长度限制

### 阶段 4｜AI 流与工具体系
1. 抽离系统提示词与角色设定，按场景（排课/财务/学生管理）切换
2. thread_id 由前端会话/用户标识传入，支持多用户与上下文隔离 [ai_service.py](file:///i:/课程表排课助手/backend/ai_service.py#L12-L16)
3. 统一流式协议：采用 NDJSON 或 SSE（text/event-stream），类型字段限定为 token/tool/tool_end/error
4. 为工具调用增加超时/失败重试、审计日志（工具名、参数、耗时、结果截断）

### 阶段 5｜前端交互与用户体验
1. FullCalendar 时区与序列化：避免 toISOString 导致时区偏移；统一使用本地时间或后端返回的时区
2. 新增“周期课程”可视化创建 UI（与 [add_recurring_course_tool](file:///i:/课程表排课助手/backend/tools.py#L689-L840) 对齐）
3. 冲突提示：服务端返回冲突元数据，前端高亮并给出修复建议
4. 学生颜色持久化至服务端（避免 localStorage 与设备绑定）
5. 统一 API 错误提示与重试策略；对课程拖拽/缩放操作增加并发防抖

### 阶段 6｜日志、监控与运维
1. 统一结构化日志（请求 ID、路由、耗时、错误栈）；按级别输出
2. 健康检查与就绪探针（/healthz、/readyz）
3. Dockerfile + docker-compose（FastAPI + MySQL），通过环境变量注入配置
4. 版本化与发布流程：开发/预发/生产，多环境配置管理

### 阶段 7｜测试与质量保障
1. 单元测试：服务层（数据库操作、冲突检测、统计计算）
2. 集成测试：API 路由与契约校验（成功/失败分支）
3. 端到端测试：前端关键流程（创建/修改/删除课程、学生管理、AI 指令）
4. 覆盖率目标 ≥80%，接入 CI（lint + test + 构建）

## 交付与验收标准
- 安全：所有密钥与凭据移至环境变量；CORS 仅白名单；不在仓库出现明文
- 稳定：连接池与索引到位，冲突检测改为数据库侧；接口响应时间稳定
- 体验：前端无时区偏移；周期课程 UI 可用；错误提示一致
- 可观测：日志齐全，健康检查通过；Docker 化可一键启动
- 质量：测试覆盖率达标，CI 绿灯

## 建议的实施顺序
1) 安全与配置 → 2) 数据层与迁移 → 3) API 与错误 → 4) AI 流协议 → 5) 前端体验 → 6) 运维与监控 → 7) 测试与 CI

请确认是否按上述阶段推进，我将据此开始实施并逐步交付每一阶段的改动与验证。